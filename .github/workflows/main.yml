name: "打卡"

on:
  workflow_dispatch: # 允许手动运行
  schedule:
    # ---------------------------------------------------------
    # 北京时间 08:30 = UTC 00:30
    # 北京时间 18:00 = UTC 10:00
    # ---------------------------------------------------------
    - cron: "30 0 * * *"
    - cron: "0 10 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    # 设置超时为 20 分钟，给随机等待留足时间
    timeout-minutes: 20

    permissions:
      actions: write
      contents: read

    steps:
      - name: Set timezone
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 关键步骤：随机延迟 60秒 ~ 600秒 (1~10分钟)
      # 模拟真人，防止封号，同时保证时间肯定在 8:30 以后
      - name: Random Sleep (Anti-Detection)
        run: |
          echo "正在生成随机延迟时间..."
          SLEEP_TIME=$(shuf -i 60-600 -n 1)
          echo "随机延迟: $SLEEP_TIME 秒"
          sleep $SLEEP_TIME
          echo "等待结束，开始执行打卡..."

      - name: Disable IPv6
        run: |
          sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1
          sudo sysctl -w net.ipv6.conf.default.disable_ipv6=1
          sudo sysctl -p

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          check-latest: true

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate Config & Run
        env:
          MY_SECRET_JSON: ${{ secrets.USER_CONFIG }}
          TZ: Asia/Shanghai
        run: |
          # 清理无关文件
          rm -f user/example.json
          rm -f user/USER
          # 写入配置
          echo "$MY_SECRET_JSON" > user/user.json
          # 运行
          python main.py

      - name: Clean up workflow runs
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 2
