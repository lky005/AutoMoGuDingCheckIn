name: "打卡"

# 触发条件
on:
  workflow_dispatch: # 允许手动点按钮运行
  schedule:
    # 每天北京时间 08:30 (UTC 00:30)
    - cron: "30 0 * * *"
    # 每天北京时间 17:30 (UTC 09:30) - 备用补签
    - cron: "30 9 * * *"

# 并发控制：避免重复运行
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      actions: write
      contents: read

    steps:
      # 1. 设置时区 (北京时间)
      - name: Set timezone
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"

      # 2. 下载代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 3. 【关键修复】禁用 IPv6 (防止工学云网络连不上)
      - name: Disable IPv6
        run: |
          sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1
          sudo sysctl -w net.ipv6.conf.default.disable_ipv6=1
          sudo sysctl -p

      # 4. 准备 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          check-latest: true

      # 5. 缓存依赖包 (加快运行速度)
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 6. 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 7. 【关键修复】生成配置并运行
      - name: Generate Config & Run
        env:
          # 必须和你设置的 Secret 名字一致
          MY_SECRET_JSON: ${{ secrets.USER_CONFIG }}
          TZ: Asia/Shanghai
        run: |
          # A. 清理干扰文件 (删除自带的演示文件和报错文件)
          rm -f user/example.json
          rm -f user/USER
          
          # B. 把你的 Secret 写入真正的 user.json
          echo "$MY_SECRET_JSON" > user/user.json
          
          # C. 运行脚本
          python main.py

      # 8. 清理历史记录 (保持页面干净)
      - name: Clean up workflow runs
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 2
