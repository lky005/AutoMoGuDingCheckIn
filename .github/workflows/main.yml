name: "打卡"

# 明确触发条件
on:
  workflow_dispatch: # 手动触发
  schedule:
    # 使用 UTC 时间，UTC 时间 对应 北京时间 -8 小时
    - cron: "30 0 * * *" # UTC 00:30 / 北京时间 08:30
    - cron: "30 9 * * *" # UTC 09:30 / 北京时间 17:30

# 配置并发控制，避免任务重叠执行
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # 添加超时限制

    permissions:
      actions: write
      contents: read

    steps:
      # 1. 设置时区为 Asia/Shanghai
      - name: Set timezone
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"

      # 2. 检出代码仓库
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # 优化克隆深度

      # 3. 【关键修改】禁用 IPv6 (修复工学云网络报错)
      - name: Disable IPv6
        run: |
          sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1
          sudo sysctl -w net.ipv6.conf.default.disable_ipv6=1
          sudo sysctl -p

      # 4. 设置 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip" # 启用 pip 缓存
          check-latest: true

      # 5. 缓存 pip 依赖
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 6. 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 7. 【关键修改】生成配置并执行 (读取你的 USER_CONFIG)
      - name: Generate Config & Run
        env:
          # 注意：这里必须用你之前设置的 Secret 名字 "USER_CONFIG"
          MY_SECRET_JSON: ${{ secrets.USER_CONFIG }}
          TZ: Asia/Shanghai
        run: |
          # 把 Secret 里的内容写入 user/user.json
          echo "$MY_SECRET_JSON" > user/user.json
          
          # 运行主程序
          python main.py

      # 8. 清理运行记录 (保持干净)
      - name: Clean up workflow runs
        if: always()
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 2
